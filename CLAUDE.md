# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Common Commands

### Development
```bash
npm run dev          # Start development server with Turbo
npm run build        # Build for production
npm start            # Start production server
npm run lint         # Run ESLint
```

### Database Management
```bash
npm run db:setup     # Setup/initialize the database
npm run db:backup    # Backup database data
```

### Additional Scripts
```bash
node scripts/generate-icons.js  # Generate PWA icons
```

## Project Overview

A **Quran Memorization School Management System** built with Next.js 15, TypeScript, and Tailwind CSS. It's a Progressive Web App (PWA) with full offline support, Arabic/English internationalization, and comprehensive student/teacher management features.

### Key Features
- Student & Teacher Management
- Attendance Tracking with Reports
- Weekly Schedule Management
- Offline-first architecture with IndexedDB
- Arabic (RTL) and English (LTR) support
- PWA with push notifications and background sync
- Auto-updates when new versions are available

## Architecture

### Core Technologies
- **Framework**: Next.js 15 (App Router)
- **Language**: TypeScript 5
- **Styling**: Tailwind CSS 4
- **Database**: Dexie.js (IndexedDB) - offline-first
- **Internationalization**: next-intl (Arabic default, English support)
- **PWA**: next-pwa with service worker and caching strategies

### High-Level Structure

```
src/
├── app/                    # Next.js App Router pages
│   ├── [locale]/          # Internationalized routes (e.g., /en, /ar)
│   │   ├── page.tsx       # Dashboard (home)
│   │   ├── students/      # Student management pages
│   │   ├── teachers/      # Teacher management pages
│   │   ├── schedule/      # Schedule view
│   │   └── attendance/    # Attendance tracking + reports
│   ├── api/               # API routes (server-side)
│   └── layout.tsx         # Root layout
├── lib/                   # Core business logic
│   ├── dexieDB.ts         # Dexie database with CRUD operations
│   ├── backgroundSync.ts  # PWA background sync
│   └── pushNotifications.ts # Push notification service
├── types/
│   └── index.ts           # TypeScript type definitions
├── i18n/                  # Internationalization
│   ├── config.ts          # Locale configuration
│   ├── request.ts         # Next-intl request handling
│   └── loadMessages.ts    # Message loading
├── components/            # Reusable React components
├── utils/                 # Utilities and helpers
├── data/                  # Mock/seed data
└── hooks/                 # Custom React hooks
```

### Database Schema (Dexie/IndexedDB)

The app uses **Dexie.js** (IndexedDB) for offline-first data persistence with versioned schema (v2):

**Tables with Indexes**:
- `students` - id, name, parentPhone, teacherId, status
- `teachers` - id, name, email, phone, status
- `schedule` - id, teacherId, day
- `attendance` - id, studentId, date, [studentId+date] (composite index)
- `syncQueue` - id, type, action, timestamp

**Schema Version 2** (line 35 in dexieDB.ts):
```typescript
this.version(2).stores({
  students: 'id, name, parentPhone, teacherId, status',
  teachers: 'id, name, email, phone, status',
  schedule: 'id, teacherId, day',
  attendance: '++id, studentId, date, [studentId+date]',
  syncQueue: '++id, type, action, timestamp'
});
```

**Storage Migration**: `migrateFromLocalStorage()` function (line 217) automatically migrates from localStorage to Dexie on first run, preserving all existing data.

### Internationalization

- **Default locale**: Arabic (ar) with RTL direction
- **Secondary locale**: English (en) with LTR direction
- **URL pattern**: `/[locale]/[page]` (e.g., `/ar/students`, `/en/teachers`)
- **Messages**: JSON files in `messages/` directory (ar.json, en.json)
- **next-intl setup**: Plugin configured in `next.config.ts` with `./src/i18n/request.ts`
- **Direction handling**: `getDirection(locale)` utility in `src/i18n/config.ts`
- **Translation hooks**: Use `useTranslations()` and `useLocale()` in components

### PWA Configuration

**Service Worker**: Auto-generated by next-pwa (in `/public/sw.js`)
- Caches fonts, images, and API responses
- NetworkFirst for API calls, CacheFirst for static assets
- Skip waiting and auto-updates enabled

**Manifest**: `/public/manifest.json`
- Standalone display mode
- App shortcuts for Add Student, Attendance, Schedule
- Configured for Android TWA (Trusted Web Activity)

**Push Notifications**: Configured in `/src/lib/pushNotifications.ts`

### Data Flow

1. **Pages** (`/src/app/[locale]/*`) - Route handlers and UI
2. **Dexie Context** - Provides database access via React context
3. **Database Layer** (`/src/lib/dexieDB.ts`) - CRUD operations
4. **IndexedDB** - Persistent offline storage

**Critical**: All pages must import from `@/contexts/DexieDataContext` (not the old DataContext). See FIXES_SUMMARY.md for context-related issues that were fixed.

### API Routes

Currently minimal server-side API:
- `/src/app/api/students/route.ts` - Basic CRUD for students (in-memory storage)

Note: The app primarily uses client-side Dexie for data persistence. API routes exist but are not the main data layer.

## Important Files

### Configuration
- `next.config.ts` - Next.js config with PWA and i18n plugins
  - PWA runtime caching for fonts, images, and API routes
  - next-intl integration with `./src/i18n/request.ts`
  - ESLint warnings ignored during build (line 56)
- `package.json` - Dependencies and scripts
  - Core: next@15.4.2, react@19.1.0, typescript@5
  - Database: dexie@4.0.11, better-sqlite3@12.2.0, sql.js@1.13.0
  - UI: lucide-react@0.525.0 (icons), tailwindcss@4
  - i18n: next-intl@4.3.4
  - PWA: next-pwa@5.6.0
- `tailwind.config.ts` - Tailwind configuration
- `public/manifest.json` - PWA manifest
- `twa-manifest.json` - Android TWA (Trusted Web Activity) configuration

### Utilities & Services
- `src/utils/dexieStorage.ts` - Low-level Dexie storage operations
- `src/services/deletionService.ts` - Complex deletion workflows with validation
- `src/services/` - Additional business logic services
- `src/hooks/` - Custom React hooks for common patterns

### Core Libraries
- `src/lib/dexieDB.ts` - Database schema and operations with Arabic comments
  - Exports: `db` (Dexie instance), `studentDB`, `teacherDB`, `scheduleDB`, `attendanceDB` helpers
  - Contains migration from localStorage to Dexie
  - Provides CRUD operations for all entities
- `src/contexts/DexieDataContext.tsx` - React context for data management
  - Exports: `DataProvider` and `useData()` hook
  - Manages students and teachers with soft delete support
  - Integrates with deletionService for complex deletion workflows
- `src/types/index.ts` - TypeScript interfaces
  - Student, Teacher, ScheduleSlot, Surah, Progress interfaces
- `src/i18n/config.ts` - Locale configuration (ar, en)

### Critical Context
- **Context API**: Use `useData()` from `@/contexts/DexieDataContext` throughout the app
- **Common error**: "useData must be used within a DataProvider" - wrap components with DataProvider
- **DataProvider**: Provides loading state with spinner while data loads

## Development Guidelines

### Hydration Error Prevention
- Never use `Date()`, `Math.random()` in initial renders
- Use `useEffect` for client-only logic
- Keep component structure consistent between loading and loaded states
- Initialize state with static values, update in `useEffect`

### Storage Patterns
- **Dexie.js** is the primary storage (IndexedDB) with versioned schema
- **LocalStorage** migration happens automatically on first run via `migrateFromLocalStorage()`
- Use helper exports from `dexieDB.ts`:
  - `studentDB` - CRUD operations for students
  - `teacherDB` - CRUD operations for teachers
  - `scheduleDB` - Schedule management
  - `attendanceDB` - Attendance tracking with date-based queries
  - `db` - Direct Dexie instance for complex queries

### Data Management Patterns
- **Soft Delete**: Students/teachers marked with `isDeleted: true` instead of hard delete
- **Deletion Service**: Complex deletion workflows in `@/services/deletionService`
- **Status Tracking**: All entities have status field (active/inactive/graduated for students)
- **Audit Trail**: Deleted entities track `deletedAt` and `deletedBy` fields

### Internationalization
- Default to Arabic in code and comments
- Use `next-intl` hooks: `useTranslations()`, `useLocale()`
- All UI strings should use translation keys, not hardcoded text
- RTL support is built into Tailwind and the layout

### PWA Development
- Service worker auto-updates on new deployments
- Background sync queues failed requests
- Push notifications support included but may need backend setup
- Test PWA features: `npm run build && npm start` (PWA disabled in dev)

## Common Issues & Solutions

### React Hydration Mismatches
**Symptom**: Console warnings about hydration differences
**Fix**: Check FIXES_SUMMARY.md - ensure consistent component structure in loading states

### Context Import Errors
**Symptom**: "useData must be used within a DataProvider"
**Fix**: Import from `@/contexts/DexieDataContext` not `@/contexts/DataContext`

### PWA Not Working in Dev
**Expected**: PWA features disabled in development (`disable: process.env.NODE_ENV === 'development'`)
**Test PWA**: Use production build (`npm run build && npm start`)

### Database Migration
**Auto-migration**: From localStorage to Dexie happens on app startup
**Reset database**: Use `src/utils/resetData.ts` or clear IndexedDB in browser dev tools

### Build Errors
**ESLint warnings ignored during build**: Configured in next.config.ts (line 56)
**Type errors**: Will fail build - fix TypeScript issues before deploying

## Scripts Directory

- `scripts/setup-db.js` - Database initialization
- `scripts/backup-db.js` - Backup database
- `scripts/generate-icons.js` - Generate PWA icons from SVG

## TypeScript Configuration

- **TypeScript 5** with strict mode enabled
- **Path mapping**: `@/*` maps to `src/*` (configured in tsconfig.json)
- **Type coverage**: All components, hooks, and data models are fully typed
- **Common types**: Student, Teacher, ScheduleSlot, AttendanceRecord interfaces in `src/types/index.ts`
- **Build validation**: `tsc --noEmit` can be used to check types without building

## Technical Debt & Notes

1. **API Routes**: Currently use in-memory storage - not production ready
2. **Mock Data**: Using local seed data - needs backend integration
3. **Push Notifications**: Requires backend for production use
4. **ESLint**: Configured to ignore errors during build (line 56 in next.config.ts) - not recommended for production
5. **Context API**: Was recently refactored - see FIXES_SUMMARY.md for details
6. **Database**: Multiple storage options (Dexie, SQLite, sql.js) - could be simplified
7. **Migration**: Automatic localStorage→Dexie migration works but could be improved

## Recent Major Changes

- **PWA Support**: Added service worker, manifest, background sync, push notifications
- **Database Migration**: From localStorage to Dexie/IndexedDB
- **Context Refactoring**: Removed old DataContext, using DexieDataContext
- **Android TWA**: Configured for Trusted Web Activity deployment

See FIXES_SUMMARY.md and NEXT-STEP.md for detailed recent changes.

## Deployment Notes

- **Vercel**: Recommended deployment platform
- **PWA**: Requires HTTPS in production
- **Icons**: Generate via `scripts/generate-icons.js` if modifying
- **Build**: `npm run build` must succeed before deployment
